# 修改程式的保障

除非是只用一次的程式，否則任何程式都有機會需要被維護，而維護就表示我們需要在程式上面新增功能或進行修改。而當我們很難對目前程式新增或修整功能時，就需要對程式進行重構。

簡單來說，重構就是整理我們的程式碼，讓它更加乾淨。而重構最重要的，是不能改變程式碼原有的功能；換句話說，不論我們怎麼改，原有的測試都要通過。

接下來我們要為 `Cart.php` 加入一個運費計算，當總金額未滿 $500 時，要加入 $20 的運費；另外我們把運費也當做是其中一個商品，它的價格是 $20 ，這在實務上是很常見的做法。

## 重構 `Cart.php`

首先要先決定重構的方向，既然運費是其中一項商品，我們就把它加到 `Cart::$prdoucts` 裡：




來看原來的 `updateQuantities` 方法：

```php
public function updateQuantities($quantities)
{
    foreach ($quantities as $key => $qty) {
        if (!is_int($qty) || (int) $qty < 0) {
            throw new CartException("數量不正確，請輸入 0 或 0 以上的整數", 1);
        }

        $this->products[$key]['quantity'] = $qty;
        $this->products[$key]['subtotal'] =
            $this->products[$key]['quantity'] *
            $this->products[$key]['price'];
    }

    $this->total = 0;
    foreach ($this->products as $key => $product) {
        $this->total += $product['subtotal'];
    }
}
```



第一步我們先重構 `Cart.php` ，假定我們的目標是要把 `updateQuantities` 拆得更細，讓商品小計的計算和總價的計算分別放在不同的方法中。


### 重構項目設定數量與更新小計程式

將以下程式片段：

```php
$this->products[$key]['quantity'] = $qty;
$this->products[$key]['subtotal'] =
    $this->products[$key]['quantity'] *
    $this->products[$key]['price'];
```

移到 `_updateSubtotal` 方法裡：

```php
public function setQuantity($key, $qty)
{
    $this->products[$key]['quantity'] = $qty;
        $this->products[$key]['subtotal'] =
            $this->products[$key]['quantity'] *
            $this->products[$key]['price'];
}
```

接著把原來的空位取代成以下程式：
 
```php
$this->_updateSubtotal($key, $qty);
```

現在程式就會變成：

```php
public function updateQuantities($quantities)
{
    foreach ($quantities as $key => $qty) {
        if (!is_int($qty) || (int) $qty < 0) {
            throw new CartException("數量不正確，請輸入 0 或 0 以上的整數", 1);
        }

        $this->products[$key]['quantity'] = $qty;
        $this->products[$key]['subtotal'] =
            $this->products[$key]['quantity'] *
            $this->products[$key]['price'];
    }

    $this->total = 0;
    foreach ($this->products as $key => $product) {
        $this->total += $product['subtotal'];
    }
}

private function _updateSubtotal($key, $qty)
{
    $this->products[$key]['quantity'] = $qty;
        $this->products[$key]['subtotal'] =
            $this->products[$key]['quantity'] *
            $this->products[$key]['price'];
}
```

執行 `phpunit` ，測試應該要一切順利。
